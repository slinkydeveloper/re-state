{
  "id": "snapshot_1767695137722_nwvlw2a8l",
  "approvalId": "approval_1767695137718_dl0dqq7hw",
  "approvalTitle": "Design Document for Real Estate Tracker",
  "version": 1,
  "timestamp": "2026-01-06T10:25:37.722Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThe real estate tracker is implemented as a Next.js 15 application with a Restate Virtual Object backend. The system uses Restate's durable execution for reliable property scraping and state management, Vercel AI SDK for intelligent content extraction, and a simple React-based frontend for user interaction.\n\nArchitecture follows a three-tier pattern:\n1. **Frontend (Next.js React)**: Simple UI for research management, ad viewing, and AI questions\n2. **API Layer (Next.js API Routes)**: REST endpoints that interface between UI and Restate\n3. **Backend (Restate Virtual Objects)**: Stateful research objects managing ads and questions with durable AI-powered scraping\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\nNo tech.md exists yet, so we establish patterns:\n- Use Restate Virtual Objects for stateful workflow management\n- Integrate Vercel AI SDK with `@restatedev/vercel-ai-middleware` for durable LLM calls\n- Follow existing service definition patterns in `/restate/services/`\n- Use Zod for schema validation and type safety\n- Implement web scraping with cheerio + turndown (existing pattern)\n\n### Project Structure (structure.md)\n\nNo structure.md exists yet. We follow the existing conventions:\n- Restate services in `/restate/services/`\n- Scraping utilities in `/restate/services/utils/`\n- Next.js API routes in `/app/api/`\n- Frontend pages in `/app/`\n- Type definitions co-located with implementation or in dedicated types files\n- Path alias `@/` for absolute imports\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **`@restatedev/vercel-ai-middleware` (durableCalls)**: Will wrap language models to journal AI responses for deterministic replay\n- **Web scraping pattern from `agent.ts`**: The existing `readWebPage` tool demonstrates using cheerio + turndown to extract clean content from HTML\n- **`ctx.run()` pattern**: Existing services show wrapping non-deterministic operations (API calls) in `ctx.run()` for durability\n- **Zod schemas**: Existing AI tool definitions use Zod for input validation - we'll extend this to data models\n- **Error handling with `TerminalError`**: Existing weather utility shows proper use of TerminalError for permanent failures\n\n### Integration Points\n\n- **Restate Endpoint (`/restate/endpoint.ts`)**: Will register the new ResearchTracker Virtual Object alongside existing services\n- **Next.js API Route (`/app/restate/v1/[[...services]]/route.ts`)**: Already configured to serve Restate endpoint - no changes needed\n- **OpenAI Integration**: Existing openai client initialization can be reused for AI-powered analysis\n- **Vercel AI SDK Tools**: Follow existing tool definition pattern with `tool()` function and Zod schemas\n\n## Architecture\n\nThe system implements a stateful Virtual Object pattern where each research project is an independent object keyed by research name. Property scraping is handled through durable AI tool calls that use site-specific scraping logic.\n\n### Modular Design Principles\n\n- **Single File Responsibility**:\n  - One Virtual Object definition (`research-tracker.ts`)\n  - Separate scraping utilities per website (`idealista-scraper.ts`, `immobiliare-scraper.ts`)\n  - Individual API routes per concern (`/api/research/`, `/api/ads/`, `/api/questions/`)\n  - Dedicated type definitions file (`types.ts`)\n\n- **Component Isolation**:\n  - Scraping logic isolated from Virtual Object state management\n  - AI tools defined separately from main service logic\n  - Frontend components separated by page/feature\n\n- **Service Layer Separation**:\n  - Restate Virtual Object handles state and orchestration\n  - Scraping utilities handle HTTP and parsing\n  - API routes handle HTTP contracts and validation\n  - Frontend handles presentation only\n\n- **Utility Modularity**:\n  - Site-specific scrapers are independent modules\n  - Shared scraping utilities (HTML cleaning, URL validation) in common module\n\n```mermaid\ngraph TD\n    UI[Next.js Frontend] -->|HTTP| API[Next.js API Routes]\n    API -->|Restate Client| VObj[ResearchTracker Virtual Object]\n    VObj -->|ctx.run| Scraper1[Idealista Scraper]\n    VObj -->|ctx.run| Scraper2[Immobiliare Scraper]\n    VObj -->|durableCalls| AI[OpenAI via Vercel AI SDK]\n    Scraper1 -->|fetch + parse| Web1[idealista.it]\n    Scraper2 -->|fetch + parse| Web2[immobiliare.it]\n    AI -->|LLM analysis| VObj\n\n    style VObj fill:#e1f5e1\n    style API fill:#e3f2fd\n    style UI fill:#fff4e6\n```\n\n## Components and Interfaces\n\n### ResearchTracker Virtual Object (`/restate/services/research-tracker.ts`)\n\n- **Purpose:** Manages all state for a research project including criteria, ads, and questions\n- **Interfaces:**\n  - `createResearch(ctx, criteria: string): void` - Initialize new research with criteria\n  - `getCriteria(ctx): string` - Retrieve research criteria\n  - `addAd(ctx, url: string): PropertyAd` - Scrape and add property listing\n  - `getAds(ctx): PropertyAd[]` - Retrieve all ads\n  - `updateAdStatus(ctx, adId: string, status: AdStatus): void` - Change ad status\n  - `askQuestion(ctx, question: string): string` - AI analysis of properties\n  - `getQuestions(ctx): QuestionAnswer[]` - Retrieve Q&A history\n- **Dependencies:**\n  - Idealista scraper utility\n  - Immobiliare scraper utility\n  - OpenAI client (via Vercel AI SDK)\n  - `@restatedev/vercel-ai-middleware`\n- **Reuses:**\n  - `ctx.run()` pattern from existing agent service\n  - Vercel AI SDK integration pattern\n  - State management with `ctx.get()` and `ctx.set()`\n\n### Idealista Scraper Utility (`/restate/services/utils/idealista-scraper.ts`)\n\n- **Purpose:** Extract property details from idealista.it listings\n- **Interfaces:**\n  - `scrapeIdealistaAd(url: string): Promise<PropertyAd>` - Scrape and parse listing\n- **Dependencies:**\n  - cheerio (HTML parsing)\n  - turndown (HTML to Markdown)\n  - Zod (validation)\n- **Reuses:**\n  - Web scraping pattern from existing `readWebPage` tool\n  - HTML cleaning logic (remove nav, ads, scripts)\n\n### Immobiliare Scraper Utility (`/restate/services/utils/immobiliare-scraper.ts`)\n\n- **Purpose:** Extract property details from immobiliare.it listings\n- **Interfaces:**\n  - `scrapeImmobiliareAd(url: string): Promise<PropertyAd>` - Scrape and parse listing\n- **Dependencies:**\n  - cheerio (HTML parsing)\n  - turndown (HTML to Markdown)\n  - Zod (validation)\n- **Reuses:**\n  - Web scraping pattern from existing `readWebPage` tool\n  - HTML cleaning logic (remove nav, ads, scripts)\n\n### Research API Routes (`/app/api/research/`)\n\n- **Purpose:** HTTP interface for research CRUD operations\n- **Interfaces:**\n  - `POST /api/research` - Create research with name and criteria\n  - `GET /api/research/:name` - Get research details\n- **Dependencies:**\n  - `@restatedev/restate-sdk-clients` for Restate ingress client\n- **Reuses:**\n  - None (new API layer)\n\n### Ads API Routes (`/app/api/ads/`)\n\n- **Purpose:** HTTP interface for property ad operations\n- **Interfaces:**\n  - `POST /api/ads/:researchName` - Add ad by URL\n  - `GET /api/ads/:researchName` - List all ads\n  - `PATCH /api/ads/:researchName/:adId` - Update ad status\n- **Dependencies:**\n  - `@restatedev/restate-sdk-clients`\n- **Reuses:**\n  - None (new API layer)\n\n### Questions API Routes (`/app/api/questions/`)\n\n- **Purpose:** HTTP interface for AI-powered Q&A\n- **Interfaces:**\n  - `POST /api/questions/:researchName` - Ask question\n  - `GET /api/questions/:researchName` - Get Q&A history\n- **Dependencies:**\n  - `@restatedev/restate-sdk-clients`\n- **Reuses:**\n  - None (new API layer)\n\n### Research Page (`/app/research/[name]/page.tsx`)\n\n- **Purpose:** Main UI for viewing and managing a research project\n- **Interfaces:**\n  - Displays ad table with filtering/sorting\n  - Provides ad status update controls\n  - Shows question/answer sidebar\n- **Dependencies:**\n  - Next.js 15 App Router\n  - React (built-in)\n  - Fetch API for calling API routes\n- **Reuses:**\n  - None (new frontend)\n\n### Home Page (`/app/page.tsx`)\n\n- **Purpose:** Landing page for creating/selecting research\n- **Interfaces:**\n  - Research creation form\n  - List of existing research projects (optional)\n- **Dependencies:**\n  - Next.js 15 App Router\n  - React (built-in)\n- **Reuses:**\n  - None (new frontend)\n\n## Data Models\n\n### PropertyAd\n\n```typescript\nimport { z } from 'zod';\n\nexport const AdStatusSchema = z.enum([\n  'to call',\n  'to visit',\n  'sent the offer',\n  'bought',\n  'rejected'\n]);\n\nexport type AdStatus = z.infer<typeof AdStatusSchema>;\n\nexport const PropertyAdSchema = z.object({\n  id: z.string(), // Generated UUID\n  url: z.string().url(),\n  source: z.enum(['idealista', 'immobiliare']),\n  title: z.string(),\n  price: z.number().optional(),\n  location: z.string(),\n  size: z.number().optional(), // Square meters\n  rooms: z.number().optional(),\n  bathrooms: z.number().optional(),\n  description: z.string(),\n  features: z.array(z.string()),\n  status: AdStatusSchema,\n  scrapedAt: z.string(), // ISO timestamp\n});\n\nexport type PropertyAd = z.infer<typeof PropertyAdSchema>;\n```\n\n### QuestionAnswer\n\n```typescript\nimport { z } from 'zod';\n\nexport const QuestionAnswerSchema = z.object({\n  id: z.string(), // Generated UUID\n  question: z.string(),\n  answer: z.string(),\n  askedAt: z.string(), // ISO timestamp\n});\n\nexport type QuestionAnswer = z.infer<typeof QuestionAnswerSchema>;\n```\n\n### ResearchState\n\n```typescript\nimport { z } from 'zod';\n\nexport const ResearchStateSchema = z.object({\n  name: z.string(), // Virtual Object key\n  criteria: z.string(),\n  ads: z.array(PropertyAdSchema),\n  questions: z.array(QuestionAnswerSchema),\n  createdAt: z.string(), // ISO timestamp\n});\n\nexport type ResearchState = z.infer<typeof ResearchStateSchema>;\n```\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Invalid URL Domain**\n   - **Handling:** Validate URL domain in API route before calling Restate. Throw `TerminalError` if not idealista.it or immobiliare.it\n   - **User Impact:** Immediate error message: \"Only idealista.it and immobiliare.it URLs are supported\"\n\n2. **Scraping Failure (Network/Parsing)**\n   - **Handling:** Let Restate retry automatically (no TerminalError). If retries exhausted, catch and return error\n   - **User Impact:** \"Failed to scrape property listing after multiple attempts. Please try again later.\"\n\n3. **Invalid Research Name**\n   - **Handling:** Validate research name in API route (alphanumeric, hyphens, max length). Return 400 error\n   - **User Impact:** \"Research name must contain only letters, numbers, and hyphens\"\n\n4. **Ad Not Found**\n   - **Handling:** Check if adId exists in research state before updating. Throw TerminalError if not found\n   - **User Impact:** \"Property ad not found in this research\"\n\n5. **OpenAI API Failure**\n   - **Handling:** Let Restate retry API calls automatically. If persistent failure, catch and return graceful error\n   - **User Impact:** \"AI analysis temporarily unavailable. Please try again shortly.\"\n\n6. **Research Already Exists**\n   - **Handling:** In `createResearch`, check if criteria already set. If yes, throw TerminalError\n   - **User Impact:** \"Research with this name already exists. Please choose a different name.\"\n\n## Testing Strategy\n\n### Unit Testing\n\n- **Approach:** Use `@restatedev/restate-sdk-testcontainers` for testing Virtual Object handlers in isolation\n- **Key Components to Test:**\n  - ResearchTracker Virtual Object handlers (createResearch, addAd, updateAdStatus, askQuestion)\n  - Scraper utilities (mock HTTP responses, test parsing logic)\n  - URL validation logic\n  - Status transition logic\n  - State management operations (get/set)\n\n**Example Test Structure:**\n```typescript\nimport { RestateTestEnvironment } from \"@restatedev/restate-sdk-testcontainers\";\nimport { describe, it, beforeAll, afterAll, expect } from \"vitest\";\nimport { researchTracker } from \"./research-tracker\";\n\ndescribe(\"ResearchTracker\", () => {\n  let restateTestEnv: RestateTestEnvironment;\n\n  beforeAll(async () => {\n    restateTestEnv = await RestateTestEnvironment.start({\n      services: [researchTracker]\n    });\n  });\n\n  afterAll(async () => {\n    await restateTestEnv?.stop();\n  });\n\n  it(\"should create research with criteria\", async () => {\n    const client = restateTestEnv.ingress()\n      .objectClient(researchTracker, \"my-search\");\n\n    await client.createResearch(\"2 bed apartment in Milan under 300k\");\n\n    const state = restateTestEnv.stateOf(researchTracker, \"my-search\");\n    const criteria = await state.get(\"criteria\");\n\n    expect(criteria).toBe(\"2 bed apartment in Milan under 300k\");\n  });\n});\n```\n\n### Integration Testing\n\n- **Approach:** Test full flow from API routes through Restate to scrapers using test containers\n- **Key Flows to Test:**\n  - Complete research creation flow: POST /api/research → Virtual Object creation → state verification\n  - Ad addition flow: POST /api/ads → scraping → state storage → GET /api/ads\n  - Status update flow: PATCH /api/ads → state update → verification\n  - Question flow: POST /api/questions → AI call → response storage → GET /api/questions\n  - Error scenarios: invalid URLs, non-existent research, duplicate research names\n\n**Test Environment:**\n- Start RestateTestEnvironment with research tracker service\n- Use test environment baseUrl for API route testing\n- Mock external dependencies (idealista/immobiliare) with test fixtures\n\n### End-to-End Testing\n\n- **Approach:** Use Playwright or Cypress for full user journey testing in browser\n- **User Scenarios to Test:**\n  1. **New Research Creation:**\n     - Navigate to home page\n     - Fill in research name and criteria\n     - Submit and verify research page loads\n\n  2. **Add Property Listings:**\n     - Open research page\n     - Submit idealista.it URL\n     - Verify ad appears in table\n     - Submit immobiliare.it URL\n     - Verify second ad appears\n\n  3. **Status Management:**\n     - Change ad status from \"to call\" to \"to visit\"\n     - Verify status updates in UI\n     - Filter by status \"to visit\"\n     - Verify filtering works\n\n  4. **AI Q&A:**\n     - Type question in sidebar\n     - Submit question\n     - Verify answer appears\n     - Verify question saved in history\n\n  5. **Error Handling:**\n     - Submit invalid URL\n     - Verify error message displays\n     - Try to create duplicate research\n     - Verify error handling\n",
  "fileStats": {
    "size": 14271,
    "lines": 390,
    "lastModified": "2026-01-06T10:25:12.470Z"
  },
  "comments": []
}